<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CataBot - AI Academic Paper Cataloging System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            display: none;
            margin-top: 30px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .progress-info {
            text-align: center;
            color: #666;
        }

        .results-container {
            display: none;
            margin-top: 30px;
        }

        .results-container.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .btn-download {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-download:hover {
            background: #667eea;
            color: white;
        }

        .subject-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .subject-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subject-name {
            font-weight: 600;
            color: #333;
        }

        .subject-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .file-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: #f5f5f5;
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .config-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .settings-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-section h4 {
            margin-bottom: 15px;
            color: #667eea;
        }

        #settingsMessage {
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        #settingsMessage.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
            display: block;
        }

        #settingsMessage.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
            display: block;
        }

        .lang-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .lang-btn {
            background: white;
            color: #667eea;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .lang-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .history-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .history-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .history-status.completed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .history-status.failed {
            background: #ffebee;
            color: #c62828;
        }

        .history-status.cancelled {
            background: #fff3e0;
            color: #f57c00;
        }

        .history-info {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .job-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .job-details.active {
            display: block;
        }

        .papers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .papers-table th,
        .papers-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .papers-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        .papers-table tr:hover {
            background: #f8f9ff;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-card {
                padding: 20px;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .tab {
                padding: 10px 20px;
                font-size: 1em;
            }
            
            .lang-switcher {
                top: 10px;
                right: 10px;
            }
            
            .lang-btn {
                padding: 8px 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- Language Switcher -->
    <div class="lang-switcher">
        <button class="lang-btn" id="langSwitch" onclick="toggleLanguage()">ÂàáÊèõËá≥ÁπÅÈ´î‰∏≠Êñá</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 data-i18n="app_title">üìö CataBot</h1>
            <p data-i18n="app_subtitle">AI Academic Paper Cataloging System</p>
        </div>

        <div class="main-card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload', event)" data-i18n="tab_upload">üì§ Upload Files</button>
                <button class="tab" onclick="switchTab('crawl', event)" data-i18n="tab_crawl">üåê Crawl Website</button>
                <button class="tab" onclick="switchTab('directory', event)" data-i18n="tab_directory">üìÅ Local Directory</button>
                <button class="tab" onclick="switchTab('history', event)" data-i18n="tab_history">üìú Job History</button>
                <button class="tab" onclick="switchTab('settings', event)" data-i18n="tab_settings">‚öôÔ∏è Settings</button>
            </div>
            <!-- Upload Tab -->
            <div id="upload-tab" class="tab-content active">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÑ</div>
                    <h3 data-i18n="upload_drop_title">Drop PDF files here or click to browse</h3>
                    <p data-i18n="upload_drop_subtitle">Support multiple files</p>
                    <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                
                <div class="file-list" id="fileList"></div>

                <div class="input-group" style="margin-top: 20px;">
                    <label data-i18n="upload_format_label">Output Format:</label>
                    <select id="uploadFormat">
                        <option value="all" data-i18n="format_all">All Formats (Excel, HTML, JSON, CSV)</option>
                        <option value="excel" data-i18n="format_excel">Excel Only</option>
                        <option value="html" data-i18n="format_html">HTML Only</option>
                        <option value="json" data-i18n="format_json">JSON Only</option>
                        <option value="csv" data-i18n="format_csv">CSV Only</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="uploadBtn" onclick="uploadFiles()" disabled>
                    <span data-i18n="upload_button">üöÄ Start Processing</span>
                </button>
            </div>

            <!-- Crawl Tab -->
            <div id="crawl-tab" class="tab-content">
                <div class="input-group">
                    <label data-i18n="crawl_url_label">Website URL:</label>
                    <input type="url" id="crawlUrl" data-i18n="crawl_url_placeholder" placeholder="https://example.com/papers" required>
                </div>

                <div class="input-group">
                    <label data-i18n="crawl_depth_label">Crawl Depth:</label>
                    <select id="crawlDepth">
                        <option value="1" data-i18n="crawl_depth_1">1 - Current page only</option>
                        <option value="2" selected data-i18n="crawl_depth_2">2 - Recommended</option>
                        <option value="3" data-i18n="crawl_depth_3">3 - Deep crawl</option>
                    </select>
                </div>

                <div class="input-group">
                    <label data-i18n="crawl_format_label">Output Format:</label>
                    <select id="crawlFormat">
                        <option value="all" data-i18n="format_all">All Formats</option>
                        <option value="excel" data-i18n="format_excel">Excel Only</option>
                        <option value="html" data-i18n="format_html">HTML Only</option>
                        <option value="json" data-i18n="format_json">JSON Only</option>
                        <option value="csv" data-i18n="format_csv">CSV Only</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>
                        <input type="checkbox" id="useJsRendering">
                        <span data-i18n="crawl_js_rendering">Enable JavaScript Rendering (for dynamic sites)</span>
                    </label>
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;" data-i18n="crawl_js_help">
                        Use this for sites that load content with JavaScript (slower but more thorough)
                    </p>
                </div>

                <button class="btn btn-primary" onclick="startCrawl()">
                    <span data-i18n="crawl_button">üåê Start Crawling</span>
                </button>
            </div>

            <!-- Directory Tab -->
            <div id="directory-tab" class="tab-content">
                <div class="alert alert-info" data-i18n="dir_note">
                    <strong>Note:</strong> Enter the full path to a directory containing PDF files on your server.
                </div>

                <div class="input-group">
                    <label data-i18n="dir_path_label">Directory Path:</label>
                    <input type="text" id="directoryPath" data-i18n="dir_path_placeholder" placeholder="C:\Papers or /home/user/papers">
                </div>

                <div class="input-group">
                    <label data-i18n="dir_format_label">Output Format:</label>
                    <select id="directoryFormat">
                        <option value="all" data-i18n="format_all">All Formats</option>
                        <option value="excel" data-i18n="format_excel">Excel Only</option>
                        <option value="html" data-i18n="format_html">HTML Only</option>
                        <option value="json" data-i18n="format_json">JSON Only</option>
                        <option value="csv" data-i18n="format_csv">CSV Only</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="processDirectory()">
                    <span data-i18n="dir_button">üìÅ Process Directory</span>
                </button>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 data-i18n="history_title">Job History</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div class="input-group" style="margin: 0;">
                            <label style="margin-right: 8px;" data-i18n="history_sort_label">Sort by:</label>
                            <select id="historySortBy" onchange="sortJobHistory()" style="padding: 5px 10px;">
                                <option value="date_desc" data-i18n="history_sort_date_desc">Date (Newest First)</option>
                                <option value="date_asc" data-i18n="history_sort_date_asc">Date (Oldest First)</option>
                                <option value="status" data-i18n="history_sort_status">Status</option>
                                <option value="papers_desc" data-i18n="history_sort_papers_desc">Papers (Most First)</option>
                                <option value="papers_asc" data-i18n="history_sort_papers_asc">Papers (Least First)</option>
                                <option value="type" data-i18n="history_sort_type">Job Type</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="loadJobHistory()">
                            <span data-i18n="history_refresh">üîÑ Refresh</span>
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info" data-i18n="history_info">
                    <strong>Note:</strong> View and manage your past processing jobs. You can re-classify papers with updated settings.
                </div>

                <div id="historyList" class="history-list">
                    <p style="text-align: center; color: #666; padding: 40px;">Loading history...</p>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <h3 style="margin-bottom: 20px;" data-i18n="settings_title">AI Configuration Settings</h3>
                
                <div class="alert alert-info" data-i18n="settings_info">
                    <strong>Note:</strong> API keys are stored locally and used for classification. OpenAI provides better accuracy than keyword matching.
                </div>

                <div class="input-group">
                    <label data-i18n="settings_provider_label">AI Provider:</label>
                    <select id="aiProvider" onchange="updateProviderVisibility()">
                        <option value="openai" data-i18n="settings_provider_openai">OpenAI</option>
                        <option value="anthropic" data-i18n="settings_provider_anthropic">Anthropic Claude</option>
                        <option value="keyword" data-i18n="settings_provider_keyword">Keyword Matching (Free)</option>
                    </select>
                </div>

                <!-- OpenAI Settings -->
                <div id="openai-settings" class="settings-section">
                    <h4 data-i18n="settings_openai_section">OpenAI Settings</h4>
                    
                    <div class="input-group">
                        <label data-i18n="settings_openai_key_label">API Key:</label>
                        <input type="password" id="openaiApiKey" data-i18n="settings_openai_key_placeholder" placeholder="sk-...">
                    </div>

                    <div class="input-group">
                        <label data-i18n="settings_openai_model_label">Model:</label>
                        <select id="openaiModel">
                            <option value="gpt-4">GPT-4 (Best quality, slower)</option>
                            <option value="gpt-4-turbo-preview">GPT-4 Turbo (Fast & quality)</option>
                            <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo (Fast & cheap)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="useVisionExtraction" checked>
                            <span data-i18n="settings_vision_extraction">Enable Vision-based Metadata Extraction (GPT-4 Vision)</span>
                        </label>
                        <p style="font-size: 0.9em; color: #666; margin-top: 5px;" data-i18n="settings_vision_help">
                            Uses AI to analyze PDF images for better metadata accuracy (requires OpenAI API)
                        </p>
                    </div>

                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="useFastMode">
                            <span data-i18n="settings_fast_mode">‚ö° Fast Mode (Text-only extraction)</span>
                        </label>
                        <p style="font-size: 0.9em; color: #666; margin-top: 5px;" data-i18n="settings_fast_mode_help">
                            Faster processing but lower accuracy. Skips vision extraction and uses cache.
                        </p>
                    </div>

                    <button class="btn btn-primary" onclick="testAPI('openai')" style="margin-right: 10px;">
                        <span data-i18n="settings_test_button">üß™ Test Connection</span>
                    </button>
                </div>

                <!-- Anthropic Settings -->
                <div id="anthropic-settings" class="settings-section" style="display: none;">
                    <h4 data-i18n="settings_anthropic_section">Anthropic Settings</h4>
                    
                    <div class="input-group">
                        <label data-i18n="settings_anthropic_key_label">API Key:</label>
                        <input type="password" id="anthropicApiKey" data-i18n="settings_anthropic_key_placeholder" placeholder="sk-ant-...">
                    </div>

                    <div class="input-group">
                        <label data-i18n="settings_anthropic_model_label">Model:</label>
                        <select id="anthropicModel">
                            <option value="claude-3-opus-20240229">Claude 3 Opus (Best quality)</option>
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet (Balanced)</option>
                            <option value="claude-3-haiku-20240307" selected>Claude 3 Haiku (Fast & cheap)</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="testAPI('anthropic')" style="margin-right: 10px;">
                        <span data-i18n="settings_test_button">üß™ Test Connection</span>
                    </button>
                </div>

                <!-- Fallback Option -->
                <div class="input-group" style="margin-top: 30px;">
                    <label>
                        <input type="checkbox" id="useKeywordFallback" checked>
                        <span data-i18n="settings_fallback_label">Use Keyword Fallback:</span>
                    </label>
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;" data-i18n="settings_fallback_help">
                        Use keyword matching if AI classification fails
                    </p>
                </div>

                <!-- Custom Categories -->
                <div class="settings-section" style="margin-top: 30px;">
                    <h4 data-i18n="settings_categories_title">Custom Classification Categories</h4>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;" data-i18n="settings_categories_help">
                        Define your own subject categories for classification. Enter one category per line. Leave empty to use default categories.
                    </p>
                    
                    <div class="input-group">
                        <label data-i18n="settings_categories_label">Categories (one per line):</label>
                        <textarea id="customCategories" rows="12" style="width: 100%; padding: 10px; font-family: monospace; font-size: 0.9em;" data-i18n="settings_categories_placeholder" placeholder="Computer Science&#10;Mathematics&#10;Physics&#10;..."></textarea>
                    </div>

                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="loadDefaultCategories()" style="margin-right: 10px;">
                            <span data-i18n="settings_categories_default">üìã Load Default Categories</span>
                        </button>
                        <button class="btn" onclick="loadExampleCategories()">
                            <span data-i18n="settings_categories_example">üìö Load Example (Chinese Theology)</span>
                        </button>
                    </div>
                </div>

                <!-- Save Button -->
                <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 20px;">
                    <span data-i18n="settings_save_button">üíæ Save Settings</span>
                </button>

                <div id="settingsMessage" style="margin-top: 15px;"></div>
            </div>

            <!-- Progress Container -->
            <div class="progress-container" id="progressContainer">
                <h3 style="margin-bottom: 15px;" data-i18n="progress_title">Processing...</h3>
                
                <!-- Overall Progress -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 600;" data-i18n="progress_overall">Overall Progress</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Current Task -->
                <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="spinner"></div>
                            <span style="font-weight: 600; color: #667eea;" data-i18n="progress_current_task">Current Task:</span>
                        </div>
                        <button class="btn-secondary btn-small" onclick="cancelJob()" style="padding: 5px 15px; font-size: 0.85em; background: #ffebee; color: #c62828; border-color: #c62828;">
                            <span data-i18n="progress_cancel">‚úï Cancel Job</span>
                        </button>
                    </div>
                    <div id="progressInfo" style="color: #333; font-size: 1em;">Initializing...</div>
                </div>
                
                <!-- Progress Details -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;" data-i18n="progress_files">Files Processed</div>
                        <div style="font-size: 1.5em; font-weight: 600; color: #667eea;" id="filesProcessed">0 / 0</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;" data-i18n="progress_papers">Papers Found</div>
                        <div style="font-size: 1.5em; font-weight: 600; color: #667eea;" id="papersFound">0</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;" data-i18n="progress_time">Elapsed Time</div>
                        <div style="font-size: 1.5em; font-weight: 600; color: #667eea;" id="elapsedTime">0s</div>
                    </div>
                </div>
                
                <!-- Processing Log -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600;" data-i18n="progress_log">Processing Log</span>
                        <button class="btn-secondary btn-small" onclick="toggleLog()" style="padding: 5px 15px; font-size: 0.85em;">
                            <span id="logToggle" data-i18n="progress_log_show">Show Details</span>
                        </button>
                    </div>
                    <div id="processingLog" style="display: none; background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">
                        <div style="color: #666;">Waiting for updates...</div>
                    </div>
                </div>
            </div>

            <!-- Results Container -->
            <div class="results-container" id="resultsContainer">
                <h2 style="margin-bottom: 20px;" data-i18n="results_title">‚úÖ Processing Complete!</h2>
                
                <div class="stats-grid" id="statsGrid"></div>

                <h3 style="margin-bottom: 15px;" data-i18n="results_download_title">Download Results:</h3>
                <div class="download-buttons" id="downloadButtons"></div>

                <div id="periodicalSummaryContainer"></div>

                <h3 style="margin-bottom: 15px;" data-i18n="results_subject_title">Subject Distribution:</h3>
                <div class="subject-list" id="subjectList"></div>

                <button class="btn btn-primary" onclick="resetForm()" style="margin-top: 30px;">
                    <span data-i18n="results_reset_button">üîÑ Process More Files</span>
                </button>
            </div>
        </div>

        <!-- Config Info -->
        <div class="main-card">
            <h3 style="margin-bottom: 15px;" data-i18n="config_title">‚öôÔ∏è System Configuration</h3>
            <div class="config-info" id="configInfo">
                <div class="config-item">
                    <span data-i18n="config_ai">AI Classification:</span>
                    <span id="aiStatus" data-i18n="config_loading">Loading...</span>
                </div>
                <div class="config-item">
                    <span data-i18n="config_categories">Supported Categories:</span>
                    <span id="categoryCount" data-i18n="config_loading">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let currentJobId = null;
        let statusCheckInterval = null;
        let jobStartTime = null;
        let processingLog = [];
        let logVisible = false;

        // Load configuration
        fetch('/api/config')
            .then(r => r.json())
            .then(data => {
                const aiStatus = document.getElementById('aiStatus');
                aiStatus.textContent = data.has_openai_key ? t('config_ai_configured') : t('config_ai_free');
                aiStatus.removeAttribute('data-i18n');
                
                const categoryCount = document.getElementById('categoryCount');
                categoryCount.textContent = `${data.subject_categories.length} ${currentLang === 'zh-TW' ? 'ÂÄãÈ°ûÂà•' : 'categories'}`;
                categoryCount.removeAttribute('data-i18n');
            });

        // Check for ongoing job on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedJobId = localStorage.getItem('catabot_current_job');
            if (savedJobId) {
                currentJobId = savedJobId;
                checkJobStatus();
            }
        });

        async function checkJobStatus() {
            try {
                const response = await fetch(`/api/status/${currentJobId}`);
                const data = await response.json();
                
                if (response.ok && (data.status === 'processing' || data.status === 'crawling' || data.status === 'pending')) {
                    // Job is still running, resume monitoring
                    showProgress();
                    startStatusCheck();
                } else if (data.status === 'completed') {
                    // Job completed, show results
                    showProgress();
                    showResults(data);
                    localStorage.removeItem('catabot_current_job');
                } else {
                    // Job not found or failed, clear storage
                    localStorage.removeItem('catabot_current_job');
                }
            } catch (error) {
                console.error('Failed to check job status:', error);
                localStorage.removeItem('catabot_current_job');
            }
        }

        function switchTab(tab, event) {
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });
            
            // Hide progress and results containers
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('resultsContainer').classList.remove('active');
            
            // Activate clicked tab button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find the button by tab name
                document.querySelector(`button[onclick*="switchTab('${tab}')"]`)?.classList.add('active');
            }
            
            // Show selected tab content
            const tabContent = document.getElementById(`${tab}-tab`);
            if (tabContent) {
                tabContent.classList.add('active');
                tabContent.style.display = 'block';
            }
            
            // Load history when switching to history tab
            if (tab === 'history') {
                loadJobHistory();
            }
        }

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.pdf'));
            if (files.length > 0) {
                selectedFiles = files;
                displayFileList();
            }
        });

        function handleFileSelect(event) {
            selectedFiles = Array.from(event.target.files);
            displayFileList();
        }

        function displayFileList() {
            const fileList = document.getElementById('fileList');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                uploadBtn.disabled = true;
                return;
            }
            
            fileList.innerHTML = selectedFiles.map((file, i) => `
                <div class="file-item">
                    <span>üìÑ ${file.name}</span>
                    <span>${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                </div>
            `).join('');
            
            uploadBtn.disabled = false;
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;
            
            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('files[]', file));
            formData.append('format', document.getElementById('uploadFormat').value);
            formData.append('language', currentLang);  // Send current language for summary
            
            showProgress();
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentJobId = data.job_id;
                    localStorage.setItem('catabot_current_job', currentJobId);
                    startStatusCheck();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        async function startCrawl() {
            const url = document.getElementById('crawlUrl').value;
            if (!url) {
                alert(t('msg_no_url'));
                return;
            }
            
            showProgress();
            
            try {
                const response = await fetch('/api/crawl', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        url: url,
                        depth: parseInt(document.getElementById('crawlDepth').value),
                        format: document.getElementById('crawlFormat').value,
                        use_js_rendering: document.getElementById('useJsRendering').checked,
                        language: currentLang  // Send current language for summary
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentJobId = data.job_id;
                    localStorage.setItem('catabot_current_job', currentJobId);
                    startStatusCheck();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Crawl failed: ' + error.message);
            }
        }

        async function processDirectory() {
            const directory = document.getElementById('directoryPath').value;
            if (!directory) {
                alert(t('msg_no_directory'));
                return;
            }
            
            showProgress();
            
            try {
                const response = await fetch('/api/directory', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        directory: directory,
                        format: document.getElementById('directoryFormat').value,
                        language: currentLang  // Send current language for summary
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentJobId = data.job_id;
                    localStorage.setItem('catabot_current_job', currentJobId);
                    startStatusCheck();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Processing failed: ' + error.message);
            }
        }

        function startStatusCheck() {
            jobStartTime = Date.now();
            processingLog = [];
            addLogEntry('Job started');
            statusCheckInterval = setInterval(checkStatus, 1000);
            updateElapsedTime();
        }

        async function checkStatus() {
            if (!currentJobId) return;
            
            try {
                const response = await fetch(`/api/status/${currentJobId}`);
                const data = await response.json();
                
                updateProgress(data);
                
                if (data.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    localStorage.removeItem('catabot_current_job');
                    addLogEntry('‚úì Processing completed successfully');
                    showResults(data);
                } else if (data.status === 'failed' || data.status === 'cancelled') {
                    clearInterval(statusCheckInterval);
                    localStorage.removeItem('catabot_current_job');
                    const msg = data.status === 'cancelled' ? 'Job cancelled by user' : (data.error || 'Unknown error');
                    addLogEntry('‚úó Processing failed: ' + msg);
                    showError(msg);
                }
            } catch (error) {
                console.error('Status check failed:', error);
            }
        }

        function updateProgress(data) {
            const percent = data.total > 0 ? Math.round((data.progress / data.total) * 100) : 0;
            
            // Update progress bar
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            
            // Update current task
            document.getElementById('progressInfo').textContent = data.current_file || 'Processing...';
            
            // Update stats
            document.getElementById('filesProcessed').textContent = `${data.progress} / ${data.total}`;
            
            // Update papers found (from results if available)
            const papersCount = data.results_count || 0;
            document.getElementById('papersFound').textContent = papersCount;
            
            // Add to log if current file changed
            if (data.current_file && !processingLog.find(entry => entry.includes(data.current_file))) {
                addLogEntry(`Processing: ${data.current_file}`);
            }
            
            // Update status-specific messages
            if (data.status === 'crawling') {
                addLogEntry('üåê Crawling website for PDFs...');
            } else if (data.status === 'processing' && data.current_file.includes('Classifying')) {
                addLogEntry('ü§ñ Classifying papers with AI...');
            } else if (data.current_file.includes('Generating catalog')) {
                addLogEntry('üìä Generating output files...');
            }
        }

        function updateElapsedTime() {
            if (!jobStartTime) return;
            
            const elapsed = Math.floor((Date.now() - jobStartTime) / 1000);
            document.getElementById('elapsedTime').textContent = elapsed + 's';
            
            if (statusCheckInterval) {
                setTimeout(updateElapsedTime, 1000);
            }
        }

        function addLogEntry(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            
            // Avoid duplicates
            if (processingLog[processingLog.length - 1] !== entry) {
                processingLog.push(entry);
                updateLogDisplay();
            }
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('processingLog');
            if (processingLog.length > 0) {
                logDiv.innerHTML = processingLog.map(entry => 
                    `<div style="margin-bottom: 3px;">${entry}</div>`
                ).join('');
                // Auto-scroll to bottom
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        function toggleLog() {
            logVisible = !logVisible;
            const logDiv = document.getElementById('processingLog');
            const toggleBtn = document.getElementById('logToggle');
            
            if (logVisible) {
                logDiv.style.display = 'block';
                toggleBtn.textContent = t('progress_log_hide');
                toggleBtn.removeAttribute('data-i18n');
            } else {
                logDiv.style.display = 'none';
                toggleBtn.textContent = t('progress_log_show');
                toggleBtn.removeAttribute('data-i18n');
            }
        }

        function showProgress() {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('resultsContainer').classList.remove('active');
            
            // Reset progress display
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('filesProcessed').textContent = '0 / 0';
            document.getElementById('papersFound').textContent = '0';
            document.getElementById('elapsedTime').textContent = '0s';
            document.getElementById('progressInfo').textContent = 'Initializing...';
            processingLog = [];
            logVisible = false;
            document.getElementById('processingLog').style.display = 'none';
            const logToggle = document.getElementById('logToggle');
            logToggle.textContent = t('progress_log_show');
            logToggle.setAttribute('data-i18n', 'progress_log_show');
        }

        function showResults(data) {
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('resultsContainer').classList.add('active');
            
            // Stats
            const statsHtml = `
                <div class="stat-card">
                    <h3>${data.results_count}</h3>
                    <p>${t('results_stats_papers')}</p>
                </div>
                <div class="stat-card">
                    <h3>${Object.keys(data.subject_distribution).length}</h3>
                    <p>${t('results_stats_categories')}</p>
                </div>
                <div class="stat-card">
                    <h3>${data.duration ? Math.round(data.duration) : 0}s</h3>
                    <p>${t('results_stats_time')}</p>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            // Download buttons
            const downloadHtml = Object.keys(data.output_files).map(format => `
                <a href="/api/download/${currentJobId}/${format}" class="btn btn-download">
                    üì• Download ${format.toUpperCase()}
                </a>
            `).join('');
            document.getElementById('downloadButtons').innerHTML = downloadHtml;
            
            // Periodical Summary (if available)
            const summaryContainer = document.getElementById('periodicalSummaryContainer');
            if (data.periodical_summary && data.periodical_summary.summary) {
                const summaryHtml = `
                    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; color: #333;">üì∞ ${t('results_summary_title')}</h3>
                        <p style="margin-bottom: 10px;"><strong>${t('results_summary_journal')}:</strong> ${data.periodical_summary.journal_name || 'N/A'}</p>
                        <p style="margin-bottom: 10px;"><strong>${t('results_summary_issue')}:</strong> ${data.periodical_summary.issue_info || 'N/A'}</p>
                        <p style="margin-bottom: 10px;"><strong>${t('results_summary_themes')}:</strong> ${(data.periodical_summary.key_themes || []).join(', ') || 'N/A'}</p>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #667eea;">
                            <p style="margin: 0; line-height: 1.6; color: #333;">${data.periodical_summary.summary}</p>
                        </div>
                    </div>
                `;
                summaryContainer.innerHTML = summaryHtml;
            } else {
                summaryContainer.innerHTML = '';
            }
            
            // Subject distribution
            const subjectHtml = Object.entries(data.subject_distribution)
                .sort((a, b) => b[1] - a[1])
                .map(([subject, count]) => `
                    <div class="subject-item">
                        <span class="subject-name">${subject}</span>
                        <span class="subject-count">${count}</span>
                    </div>
                `).join('');
            document.getElementById('subjectList').innerHTML = subjectHtml;
        }

        function showError(message) {
            document.getElementById('progressContainer').classList.remove('active');
            alert(t('msg_error') + message);
            resetForm();
        }

        async function cancelJob() {
            if (!currentJobId) return;
            
            if (!confirm(t('progress_cancel_confirm'))) {
                return;
            }
            
            try {
                const response = await fetch(`/api/cancel/${currentJobId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addLogEntry('‚úï Job cancelled by user');
                    clearInterval(statusCheckInterval);
                    localStorage.removeItem('catabot_current_job');
                    alert(t('progress_cancelled'));
                    resetForm();
                } else {
                    alert(t('progress_cancel_failed') + ': ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert(t('progress_cancel_failed') + ': ' + error.message);
            }
        }

        function resetForm() {
            selectedFiles = [];
            currentJobId = null;
            localStorage.removeItem('catabot_current_job');
            
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
            
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('fileInput').value = '';
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('resultsContainer').classList.remove('active');
            document.getElementById('periodicalSummaryContainer').innerHTML = '';
        }

        // History functions
        let allJobs = []; // Store all jobs for sorting
        
        async function loadJobHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Loading history...</p>';
            
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                if (data.jobs && data.jobs.length > 0) {
                    allJobs = data.jobs;
                    sortJobHistory(); // Apply current sort
                } else {
                    allJobs = [];
                    historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No job history found.</p>';
                }
            } catch (error) {
                allJobs = [];
                historyList.innerHTML = '<p style="text-align: center; color: #c62828; padding: 40px;">Failed to load history: ' + error.message + '</p>';
            }
        }
        
        function sortJobHistory() {
            if (allJobs.length === 0) return;
            
            const sortBy = document.getElementById('historySortBy').value;
            const historyList = document.getElementById('historyList');
            
            let sortedJobs = [...allJobs];
            
            switch(sortBy) {
                case 'date_desc':
                    sortedJobs.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
                    break;
                case 'date_asc':
                    sortedJobs.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
                    break;
                case 'status':
                    const statusOrder = { 'completed': 0, 'failed': 1, 'cancelled': 2 };
                    sortedJobs.sort((a, b) => {
                        const orderDiff = statusOrder[a.status] - statusOrder[b.status];
                        if (orderDiff !== 0) return orderDiff;
                        return new Date(b.start_time) - new Date(a.start_time);
                    });
                    break;
                case 'papers_desc':
                    sortedJobs.sort((a, b) => (b.results_count || 0) - (a.results_count || 0));
                    break;
                case 'papers_asc':
                    sortedJobs.sort((a, b) => (a.results_count || 0) - (b.results_count || 0));
                    break;
                case 'type':
                    sortedJobs.sort((a, b) => {
                        const typeDiff = a.job_type.localeCompare(b.job_type);
                        if (typeDiff !== 0) return typeDiff;
                        return new Date(b.start_time) - new Date(a.start_time);
                    });
                    break;
            }
            
            historyList.innerHTML = sortedJobs.map(job => createHistoryItem(job)).join('');
        }

        function createHistoryItem(job) {
            // Debug: Log job info
            if (job.job_type === 'crawl') {
                console.log(`Crawl job ${job.job_id}: has source_url = ${!!job.source_url}`, job.source_url);
            }
            
            const startDate = new Date(job.start_time);
            const endDate = job.end_time ? new Date(job.end_time) : null;
            const duration = endDate ? Math.round((endDate - startDate) / 1000) : 0;
            
            let statusClass, statusText;
            if (job.status === 'completed') {
                statusClass = 'completed';
                statusText = '‚úì Completed';
            } else if (job.status === 'cancelled') {
                statusClass = 'cancelled';
                statusText = '‚äó Cancelled';
            } else {
                statusClass = 'failed';
                statusText = '‚úó Failed';
            }
            
            const typeEmoji = {
                'upload': 'üì§',
                'crawl': 'üåê',
                'directory': 'üìÅ',
                'reclassify': 'üîÑ'
            };
            
            return `
                <div class="history-item" id="history-${job.job_id}">
                    <div class="history-header">
                        <div class="history-title">
                            ${typeEmoji[job.job_type] || 'üìÑ'} ${job.job_type.charAt(0).toUpperCase() + job.job_type.slice(1)} Job
                        </div>
                        <div class="history-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="history-info">
                        <strong>Job ID:</strong> ${job.job_id}<br>
                        <strong>Started:</strong> ${startDate.toLocaleString()}<br>
                        ${endDate ? `<strong>Duration:</strong> ${duration}s<br>` : ''}
                        <strong>Papers:</strong> ${job.results_count || 0}
                        ${job.source_url ? `<br><strong>Source:</strong> ${job.source_url}` : ''}
                        ${job.error ? `<br><strong style="color: #c62828;">Error:</strong> ${job.error}` : ''}
                    </div>
                    <div class="history-actions">
                        <button class="btn btn-secondary btn-small" onclick="viewJobDetails('${job.job_id}')">
                            üëÅÔ∏è <span data-i18n="history_view_details">View Details</span>
                        </button>
                        ${job.status === 'completed' && job.results_count > 0 ? `
                            <button class="btn btn-primary btn-small" onclick="reclassifyJob('${job.job_id}')">
                                üîÑ <span data-i18n="history_reclassify">Re-classify</span>
                            </button>
                        ` : ''}
                        ${job.job_type === 'crawl' && job.source_url ? `
                            <button class="btn btn-primary btn-small" onclick="refetchJob('${job.job_id}')">
                                üîÉ <span data-i18n="history_refetch">Re-fetch & Re-classify</span>
                            </button>
                        ` : ''}
                    </div>
                    <div class="job-details" id="details-${job.job_id}">
                        <p style="text-align: center; color: #666;">Loading details...</p>
                    </div>
                </div>
            `;
        }

        async function viewJobDetails(jobId) {
            const detailsDiv = document.getElementById(`details-${jobId}`);
            
            // Toggle visibility
            if (detailsDiv.classList.contains('active')) {
                detailsDiv.classList.remove('active');
                return;
            }
            
            detailsDiv.classList.add('active');
            detailsDiv.innerHTML = '<p style="text-align: center; color: #666;">Loading details...</p>';
            
            try {
                const response = await fetch(`/api/history/${jobId}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayJobDetails(detailsDiv, data);
                } else {
                    detailsDiv.innerHTML = `<p style="color: #c62828;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                detailsDiv.innerHTML = `<p style="color: #c62828;">Failed to load details: ${error.message}</p>`;
            }
        }

        function displayJobDetails(container, data) {
            // Subject distribution
            let subjectHtml = '';
            if (data.subject_distribution) {
                subjectHtml = '<h4 style="margin-bottom: 10px;">Subject Distribution:</h4>';
                subjectHtml += '<div class="subject-list" style="margin-bottom: 20px;">';
                subjectHtml += Object.entries(data.subject_distribution)
                    .sort((a, b) => b[1] - a[1])
                    .map(([subject, count]) => `
                        <div class="subject-item">
                            <span class="subject-name">${subject}</span>
                            <span class="subject-count">${count}</span>
                        </div>
                    `).join('');
                subjectHtml += '</div>';
            }
            
            // Download buttons
            let downloadHtml = '';
            if (data.output_files && Object.keys(data.output_files).length > 0) {
                downloadHtml = '<h4 style="margin-bottom: 10px;">Download Files:</h4>';
                downloadHtml += '<div class="download-buttons">';
                downloadHtml += Object.keys(data.output_files).map(format => `
                    <a href="/api/download/${data.job_id}/${format}" class="btn btn-download btn-small">
                        üì• ${format.toUpperCase()}
                    </a>
                `).join('');
                downloadHtml += '</div>';
            }
            
            // Papers table (show first 10)
            let papersHtml = '';
            if (data.papers && data.papers.length > 0) {
                papersHtml = `<h4 style="margin-bottom: 10px;">Papers (showing ${Math.min(10, data.papers.length)} of ${data.papers.length}):</h4>`;
                papersHtml += '<div style="overflow-x: auto;"><table class="papers-table">';
                papersHtml += '<thead><tr><th>Title</th><th>Authors</th><th>Year</th><th>Journal</th><th>Category</th></tr></thead>';
                papersHtml += '<tbody>';
                papersHtml += data.papers.slice(0, 10).map(paper => `
                    <tr>
                        <td>${paper.title || 'N/A'}</td>
                        <td>${paper.authors || 'N/A'}</td>
                        <td>${paper.year || 'N/A'}</td>
                        <td>${paper.journal || 'N/A'}</td>
                        <td>${paper.classification?.primary_subject || 'N/A'}</td>
                    </tr>
                `).join('');
                papersHtml += '</tbody></table></div>';
            }
            
            container.innerHTML = subjectHtml + downloadHtml + papersHtml;
        }

        async function reclassifyJob(jobId) {
            if (!confirm(t('msg_reclassify_confirm'))) {
                return;
            }
            
            try {
                const response = await fetch(`/api/reclassify/${jobId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        format: 'all'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(t('msg_reclassify_started') + ' ' + data.job_id);
                    // Switch to upload tab to show progress
                    currentJobId = data.job_id;
                    localStorage.setItem('catabot_current_job', currentJobId);
                    showProgress();
                    startStatusCheck();
                } else {
                    alert(t('msg_error') + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to start re-classification: ' + error.message);
            }
        }

        async function refetchJob(jobId) {
            if (!confirm(t('msg_refetch_confirm') || 'Re-fetch papers from the original URL and re-classify them? This will create a new job.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/refetch/${jobId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        format: 'all',
                        depth: 2,
                        use_js_rendering: false
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(t('msg_refetch_started') + ' ' + data.job_id);
                    // Switch to upload tab to show progress
                    currentJobId = data.job_id;
                    localStorage.setItem('catabot_current_job', currentJobId);
                    switchTab('upload');
                    showProgress();
                    startStatusCheck();
                } else {
                    alert(t('msg_error') + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to start re-fetch: ' + error.message);
            }
        }

        // Settings functions
        function loadSettings() {
            fetch('/api/settings')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('aiProvider').value = data.ai_provider || 'openai';
                    document.getElementById('openaiApiKey').value = data.openai_api_key || '';
                    document.getElementById('openaiModel').value = data.openai_model || 'gpt-3.5-turbo';
                    document.getElementById('anthropicApiKey').value = data.anthropic_api_key || '';
                    document.getElementById('anthropicModel').value = data.anthropic_model || 'claude-3-haiku-20240307';
                    document.getElementById('useKeywordFallback').checked = data.use_keyword_fallback !== false;
                    document.getElementById('useVisionExtraction').checked = data.use_vision_extraction !== false;
                    document.getElementById('useFastMode').checked = data.use_fast_mode === true;
                    
                    // Load custom categories
                    if (data.custom_categories && Array.isArray(data.custom_categories)) {
                        document.getElementById('customCategories').value = data.custom_categories.join('\n');
                    }
                    
                    updateProviderVisibility();
                })
                .catch(err => console.error('Failed to load settings:', err));
        }

        function updateProviderVisibility() {
            const provider = document.getElementById('aiProvider').value;
            document.getElementById('openai-settings').style.display = provider === 'openai' ? 'block' : 'none';
            document.getElementById('anthropic-settings').style.display = provider === 'anthropic' ? 'block' : 'none';
        }

        async function saveSettings() {
            // Parse custom categories
            const categoriesText = document.getElementById('customCategories').value.trim();
            let customCategories = null;
            if (categoriesText) {
                customCategories = categoriesText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
            }

            const settings = {
                ai_provider: document.getElementById('aiProvider').value,
                openai_api_key: document.getElementById('openaiApiKey').value,
                openai_model: document.getElementById('openaiModel').value,
                anthropic_api_key: document.getElementById('anthropicApiKey').value,
                anthropic_model: document.getElementById('anthropicModel').value,
                use_keyword_fallback: document.getElementById('useKeywordFallback').checked,
                use_vision_extraction: document.getElementById('useVisionExtraction').checked,
                use_fast_mode: document.getElementById('useFastMode').checked,
                custom_categories: customCategories
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                const msgDiv = document.getElementById('settingsMessage');
                
                if (response.ok) {
                    msgDiv.textContent = t('settings_saved');
                    msgDiv.className = 'success';
                    setTimeout(() => msgDiv.style.display = 'none', 3000);
                } else {
                    msgDiv.textContent = t('msg_error') + (data.error || 'Unknown error');
                    msgDiv.className = 'error';
                }
            } catch (error) {
                const msgDiv = document.getElementById('settingsMessage');
                msgDiv.textContent = t('msg_error') + error.message;
                msgDiv.className = 'error';
            }
        }

        function loadDefaultCategories() {
            const defaultCategories = [
                "Computer Science",
                "Mathematics",
                "Physics",
                "Chemistry",
                "Biology",
                "Medicine",
                "Engineering",
                "Social Sciences",
                "Economics",
                "Psychology",
                "Education",
                "Literature",
                "History",
                "Philosophy",
                "Law",
                "Business",
                "Environmental Science",
                "Other"
            ];
            document.getElementById('customCategories').value = defaultCategories.join('\n');
        }

        function loadExampleCategories() {
            const exampleCategories = [
                "ËÅñÁ∂ìÁ†îÁ©∂ÔºàÂéüÂÖ∏ÂéüÊñáÁöÑÊñáÊú¨Ë©ÆÈáãÂíåË∑®ÂÆóÊïôÁöÑÁ∂ìÂÖ∏Ëæ®ËÆÄÔºâ",
                "Âü∫Áù£ÂÆóÊïôÂÇ≥Áµ±Ôºà‰ª•Â§©‰∏ªÊïô„ÄÅÊù±Ê≠£Êïô„ÄÅÂü∫Áù£Êñ∞Êïô‰∏âÂ§ßÂÇ≥Áµ±ÁÇ∫‰∏ªÔºå‰πüÂåÖÊã¨‰ΩúÁÇ∫ÊôØÊïôÊ∫êÈ†≠ÁöÑÊïòÂà©‰∫ûÊù±ÊñπÊïôÊúÉ„ÄÅËøë‰ª£Â¥õËµ∑ÁöÑ‰∫îÊó¨ÂÆóÔºå‰ª•ÂèäËàáÂü∫Áù£ÂÆóÊïôÂÇ≥Áµ±Èóú‰øÇÊ•µÊ∑±ÁöÑÁå∂Â§™ÊïôÔºâ",
                "Á•ûÂ≠∏ÂèäÂì≤Â≠∏Á†îÁ©∂ÔºàÂü∫Áù£ÂÆóÊïôÂêÑÂ§ßÂÇ≥Áµ±ÂæûÂè§Âà∞‰ªäÁöÑÁ•ûÂ≠∏ËàáÂì≤Â≠∏ÊÄùÊÉ≥Ôºâ",
                "Ê≠∑Âè≤Á†îÁ©∂ÔºàÂü∫Áù£ÂÆóÊïô‰∏çÂêåÊ¥æÂà•‰ª•Âèä‰∏≠ÂúãÂü∫Áù£ÊïôÂè≤ÁöÑ‰∫∫Áâ©„ÄÅ‰∫ã‰ª∂„ÄÅÂïèÈ°åÔºâ",
                "ÊñáÂ≠∏ÂèäËóùË°ìÁ†îÁ©∂ÔºàÂü∫Áù£ÂÆóÊïôËàáÊñáÂ≠∏„ÄÅÂü∫Áù£ÊïôËóùË°ì„ÄÅËÅñÊ®ÇÁ≠âÔºâ",
                "Á§æÊúÉÁßëÂ≠∏Á†îÁ©∂ÔºàÂæûÁ§æÊúÉÂ≠∏„ÄÅ‰∫∫È°ûÂ≠∏„ÄÅÊîøÊ≤ªÂ≠∏„ÄÅÁ∂ìÊøüÂ≠∏„ÄÅÂøÉÁêÜÂ≠∏Á≠âÁ§æÊúÉÁßëÂ≠∏ÔºåÂ∞çÂü∫Áù£ÂÆóÊïôË´∏ÁèæË±°ÈÄ≤Ë°åÁêÜË´ñ„ÄÅÊ≠∑Âè≤ÂèäÂØ¶Ë≠âÁ†îÁ©∂Ôºâ",
                "ÊñáÂåñÁ†îÁ©∂ÔºàÂæåÁèæ‰ª£ÊÄùÊΩÆ„ÄÅÂæåÊÆñÊ∞ëÁ†îÁ©∂„ÄÅÂ•≥ÊÄß‰∏ªÁæ©ÂíåÁîüÊÖãÂ≠∏Â∞çÁèæ‰ª£ÊÄß‰πãÊâπÂà§Á≠âÔºâ",
                "ÂØ¶Ë∏êÁ•ûÂ≠∏ÔºàÂü∫Áù£ÂÆóÊïôÂêÑÂ§ßÂÇ≥Áµ±ÁöÑÁ¶ÆÂÑÄÂ≠∏„ÄÅÈùà‰øÆÂ≠∏„ÄÅÂÄ´ÁêÜÂ≠∏„ÄÅÁï∂‰ª£ÂØ¶Ë∏êË≠∞È°åÔºâ",
                "ÂÆóÊïôÂ∞çË©±ËàáË∑®ÊñáÂåñÁ†îÁ©∂Ôºà‰∏çÂêåÂÆóÊïôÂèäÊñáÂåñÂÇ≥Áµ±ËàáÂü∫Áù£ÂÆóÊïôÁöÑÂ∞çË©±Ôºâ",
                "Ë∑®Â≠∏ÁßëÁ†îÁ©∂ËàáÊº¢Ë™ûÁ•ûÂ≠∏ÔºàÊº¢Ë™ûÂü∫Áù£ÊïôÁ†îÁ©∂ËàáÁõ∏ÈóúÂ≠∏ÁßëÂçî‰ΩúÊï¥ÂêàÔºåÂÖ±ÂêåÂèÉËàáÊº¢Ë™ûÂ≠∏ÁïåÁöÑÂÖ¨ÂÖ±Ë®éË´ñÔºâ"
            ];
            document.getElementById('customCategories').value = exampleCategories.join('\n');
        }

        async function testAPI(provider) {
            const apiKey = provider === 'openai' 
                ? document.getElementById('openaiApiKey').value
                : document.getElementById('anthropicApiKey').value;

            if (!apiKey) {
                alert('Please enter an API key first');
                return;
            }

            const msgDiv = document.getElementById('settingsMessage');
            msgDiv.textContent = 'Testing connection...';
            msgDiv.className = 'success';

            try {
                const response = await fetch('/api/test-api', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: provider,
                        api_key: apiKey
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    msgDiv.textContent = t('settings_test_success');
                    msgDiv.className = 'success';
                } else {
                    msgDiv.textContent = t('settings_test_failed') + data.message;
                    msgDiv.className = 'error';
                }

                setTimeout(() => msgDiv.style.display = 'none', 5000);
            } catch (error) {
                msgDiv.textContent = t('settings_test_failed') + error.message;
                msgDiv.className = 'error';
            }
        }

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });
    </script>
    
    <!-- i18n Support -->
    <script src="/static/i18n.js"></script>
</body>
</html>
